@page
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@model SearchShipmentsByDateModel
@{
    ViewData["Title"] = "Search Shipments by Date, TO City and Booking Office";
}

<head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        @@media print {
            body *

        {
            visibility: hidden;
        }

        #print-section, #print-section * {
            visibility: visible;
        }

        #print-section {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            padding: 20px;
            font-family: Arial, sans-serif;
            margin-top: 3cm;
        }

            @@page {
                size: B4 Portrait;
            }

        }
    </style>

</head>
<script>
    console.log("Shipment ID Selected yes: ");
       function printShipmentDetails(shipmentId) {
        console.log("Shipment ID Selected:", shipmentId);

        // Find the shipment row in the table
        const rows = document.querySelectorAll("table tbody tr");
        let selectedRow = null;

        rows.forEach(row => {
            const builtyNumberCell = row.children[0]; // First cell contains the shipment ID
            if (builtyNumberCell && builtyNumberCell.textContent.trim() === shipmentId.toString()) {
                selectedRow = row;
            }
        });

        if (!selectedRow) {
            console.error("Shipment not found.");
            return;
        }

        // Populate the print section with shipment details
        document.getElementById('print-builty-number').textContent = selectedRow.children[0].textContent;
        document.getElementById('print-sender-name').textContent = selectedRow.children[1].textContent;
        document.getElementById('print-receiver-name').textContent = selectedRow.children[3].textContent;
        document.getElementById('print-city').textContent = selectedRow.children[4].textContent;
        document.getElementById('print-booking-office').textContent = selectedRow.children[2].textContent;
        document.getElementById('print-shipment-date').textContent = selectedRow.children[5].textContent;
        document.getElementById('print-description').textContent = selectedRow.children[6].textContent;
        document.getElementById('print-number-of-items').textContent = selectedRow.children[7].textContent;
        document.getElementById('print-total-weight').textContent = selectedRow.children[8].textContent;
        document.getElementById('print-price').textContent = selectedRow.children[9].textContent;
        document.getElementById('print-paymenttype').textContent = selectedRow.children[11].textContent;

        // Show the print section
         // Save the current page content
        const originalContent = document.body.innerHTML;
        const printSection = document.getElementById('print-section');
        printSection.classList.remove('d-none');

        // Trigger the print dialog
		window.document.body.innerHTML = printSection.outerHTML; // Set the body to the print section content
        window.print();
         // Restore the original page content
        document.body.innerHTML = originalContent;

        // Reload the scripts and styles
        window.location.reload();
        // Hide the print section after printing
        printSection.classList.add('d-none');
    }

</script>

<h1 class="text-center my-4">Reports</h1>

<div class="container bg-light shadow p-4 rounded">
    <!-- Back Button -->
    

    <form method="get" class="row g-3">
        <div class="row">
            <!-- Select Date -->
            <div class="col-md-4">
                <label for="FromDate" class="form-label text-primary">
                    <i class="fas fa-calendar-alt"></i> From Date
                </label>
                <input type="date" id="FromDate" name="FromDate" class="form-control" value="@Model.FromDate?.ToString("yyyy-MM-dd")" />
            </div>
            <div class="col-md-4">
                <label for="ToDate" class="form-label text-primary">
                    <i class="fas fa-calendar-alt"></i> To Date
                </label>
                <input type="date" id="ToDate" name="ToDate" class="form-control" value="@Model.ToDate?.ToString("yyyy-MM-dd")" />
            </div>


            <!-- Booking Office -->
            <div class="col-md-4">
                <label for="BookingOffice" class="form-label text-primary">
                    <i class="fas fa-building"></i> Booking Office
                </label>
                <select id="BookingOffice" name="BookingOffice" class="form-select">
                    <option value="" selected>All Booking Offices</option>
                    @if (Model.BookingOffices != null && Model.BookingOffices.Any())
                    {
                        foreach (var office in Model.BookingOffices)
                        {
                            <option value="@office">@office</option>
                        }
                    }
                </select>
            </div>

            <!-- Select To City -->
            <div class="col-md-4">
                <label for="City" class="form-label text-primary">
                    <i class="fas fa-city"></i> Select To City
                </label>
                <select id="City" name="City" class="form-select">
                    <option value="" selected>To City</option>
                    @if (Model.Cities != null && Model.Cities.Any())
                    {
                        foreach (var city in Model.Cities)
                        {
                            <option value="@city">@city</option>
                        }
                    }
                </select>
            </div>
             <div class="col-md-4">
                <label for="PaymentType" class="form-label text-primary">
                    <i class="fas fa-money-bill"></i> Payment Type
                </label>
                <select id="PaymentType" name="PaymentType" class="form-select">
                    <option value="" selected>All Payment Types</option>
                    <option value="Paid" @@(Model.PaymentType == "Paid" ? "selected" : "")>Paid</option>
                    <option value="ToBeBilled" @@(Model.PaymentType == "ToBeBilled" ? "selected" : "")>To be Billed</option>
                    <option value="ToPay" @@(Model.PaymentType == "ToPay" ? "selected" : "")>To Pay</option>
                </select>
            </div>
      
        </div>



        <div class="col-md-12 d-flex justify-content-center gap-3">
            <!-- Search Button -->
            <button type="submit" class="btn btn-primary btn-lg d-flex align-items-center">
                <i class="fas fa-search me-2"></i> Search
            </button>

            <!-- Unassigned Shipments Button -->
            <a asp-page="/SearchShipmentsByDate" asp-route-UnassignedOnly="true" class="btn btn-warning btn-lg d-flex align-items-center">
                <i class="fas fa-truck-loading me-2"></i> કેટ્ટલા દાગીના ઓફિસ મા છે?
            </a>

            <!-- Back to Home Button -->
            <a asp-page="/Index" class="btn btn-secondary btn-lg d-flex align-items-center">
                <i class="fas fa-arrow-left me-2"></i> Back to Home
            </a>
        </div>

    </form>

    @if (Model.Shipments != null && Model.Shipments.Any())
    {
        <div class="mt-4">
            <h3>
				Booking Details from: @Model.FromDate?.ToString("dd-MM-yyyy") To: @Model.ToDate?.ToString("dd-MM-yyyy")
                @if (!string.IsNullOrEmpty(Model.BookingOffice))
                {
                    <span class="text-secondary">(Booking Office: @Model.BookingOffice)</span>
                }
            </h3>
            <table class="table table-bordered table-striped">
                <thead>
                    <tr>
                        <th>Builty Number</th>
                        <th>Sender Name</th>
                        <th>Booking Office</th>
                        <th>Receiver Name</th>
                        <th>To City</th>
                        <th>Booking Date</th>
                        <th>Description</th>
                        <th>Number of Items</th>
                        <th>Total Weight</th>
                        <th>Amount</th>
                        <th>Truck Number</th>
                        <th>Payment Type</th>

                        <th>Actions</th> <!-- New column for actions -->
                    </tr>
                </thead>
                <tbody>
                    @foreach (var shipment in Model.Shipments)
                    {
                        <tr>
                            <td>@shipment.Id</td>
                            <td>@shipment.SenderName</td>
                            <td>@shipment.BookingOffice</td>
                            <td>@shipment.ReceiverName</td>
                            <td>@shipment.City</td>
                            <td>@shipment.ShipmentDateTime.ToString("dd-MM-yyyy")</td>
                            <td>@shipment.Description</td>
                            <td>@shipment.NumberOfItems</td>
                            <td>@shipment.TotalWeight</td>
                            <td>@shipment.Price</td>
                            <td>@(string.IsNullOrEmpty(shipment.TruckNumber) || shipment.TruckNumber == "Unassigned" ? "" : shipment.TruckNumber)</td>
                            <td>@shipment.PaymentStatus</td>
                            <td>
                                <form method="post" asp-page-handler="Notify" asp-route-id="@shipment.Id" class="d-inline">
                                    <button type="submit" class="btn btn-sm btn-info">
                                        <i class="fas fa-envelope"></i> Notify
                                    </button>
                                </form>
                                <button class="btn btn-secondary" onclick="printShipmentDetails(@shipment.Id)">
                                    <i class="fas fa-print"></i> Print
                                </button>
                            </td>


                        </tr>
                    }
                </tbody>
            </table>
        </div>
        <div id="print-section" class="print-section d-none">
            
            <table class="table table-bordered">
                <tbody>
                    <tr>
                        <th>Date</th>
                        <td><span id="print-shipment-date"></span></td>
                        <th>Number</th>
                        <td><span id="print-builty-number"></span></td>
                    </tr>
                    <tr>
                        <th>Sender Name</th>
                        <td><span id="print-sender-name"></span></td>
                        <th>Receiver Name</th>
                        <td><span id="print-receiver-name"></span></td>
                    </tr>
                    <tr>
                        <th>Booking Office</th>
                        <td><span id="print-booking-office"></span></td>
                        <th>To City</th>
                        <td><span id="print-city"></span></td>
                    </tr>
                    <tr>
                        <th>Number of Items</th>
                        <td><span id="print-number-of-items"></span></td>
                        <th>Weight</th>
                        <td><span id="print-total-weight"></span> Kg</td>
                    </tr>
                    <tr>
                        <th>Description</th>
                        <td><span id="print-description"></span></td>
                        <th>Price</th>
                        <td>&#8377;<span id="print-price"></span></td>
                    </tr>
                    <tr>
                        <th></th>
                        <td></td>
                        <th>Payment Type</th>
                        <td><span id="print-paymenttype"></span></td>
                    </tr>
                </tbody>
            </table>

            
           
            
            <p><strong></strong> </p>
        </div>

        



        <!-- Pagination Controls -->
        <nav aria-label="Page navigation" class="mt-4">
            <ul class="pagination justify-content-center">
                @if (Model.PageNumber > 1)
                {
                    <li class="page-item">
                        <a class="page-link" asp-page="/SearchShipmentsByDate" 
                        asp-route-PageNumber="@(Model.PageNumber - 1)"
                           asp-route-FromDate="@Model.FromDate?.ToString("yyyy-MM-dd")"
                           asp-route-ToDate="@Model.ToDate?.ToString("yyyy-MM-dd")"
                           asp-route-BookingOffice="@Model.BookingOffice"
                           asp-route-UnassignedOnly="@Model.UnassignedOnly">
                        Previous
                    </a>
                    </li>
                }
                @for (int i = 1; i <= Model.TotalPages; i++)
                {
                    <li class="page-item @(i == Model.PageNumber ? "active" : "")">
                        <a class="page-link" asp-page="/SearchShipmentsByDate" asp-route-PageNumber="@i"
                           asp-route-FromDate="@Model.FromDate?.ToString("yyyy-MM-dd")"
                           asp-route-ToDate="@Model.ToDate?.ToString("yyyy-MM-dd")"
                        asp-route-BookingOffice="@Model.BookingOffice" 
                        asp-route-UnassignedOnly="@Model.UnassignedOnly">
                        @i
                        </a>
                    </li>
                }
                @if (Model.PageNumber < Model.TotalPages)
                {
                    <li class="page-item">
                        <a class="page-link" asp-page="/SearchShipmentsByDate" 
                        asp-route-PageNumber="@(Model.PageNumber + 1)"
                           asp-route-FromDate="@Model.FromDate?.ToString("yyyy-MM-dd")"
                           asp-route-ToDate="@Model.ToDate?.ToString("yyyy-MM-dd")"
                        asp-route-BookingOffice="@Model.BookingOffice" 
                        asp-route-UnassignedOnly="@Model.UnassignedOnly">Next</a>
                    </li>
                }
            </ul>
        </nav>
    }
    else if (Model.Shipments != null)
    {
        <div class="mt-4 alert alert-warning">
            No shipments found for the selected criteria.
        </div>
    }
</div>
